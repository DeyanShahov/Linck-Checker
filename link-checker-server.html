<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blogspot Link Checker - Server Edition</title>
    <style>
        /* ==========================
           –ë–ê–ó–û–í –°–¢–ò–õ
           ========================== */
        :root{
            --bg: #ffffff;
            --surface: #f7f7f8;
            --ink: #1c1d20;
            --ink-muted: #5a5d66;
            --success: #22c55e;
            --error: #ef4444;
            --warning: #f59e0b;
            --brand: #2b6cb0;
            --border: #e5e7eb;
            --shadow: 0 4px 6px rgba(0,0,0,.1);
            --radius: 12px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font: 14px/1.5 system-ui, -apple-system, sans-serif;
            color: var(--ink);
            background: var(--bg);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ==========================
           –•–ï–î–™–†
           ========================== */
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }

        h1 {
            color: var(--brand);
            margin: 0 0 10px;
            font-size: 2rem;
        }

        .subtitle {
            color: var(--ink-muted);
            margin: 0;
        }

        .server-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
            margin-top: 10px;
        }

        .server-status.online {
            background: #f0fdf4;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .server-status.offline {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        /* ==========================
           –ö–û–ù–¢–†–û–õ–ù–ê –ü–ê–ù–ï–õ
           ========================== */
        .control-panel {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .url-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .url-input {
            flex: 1;
            min-width: 250px;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn-primary {
            background: var(--brand);
            color: white;
        }

        .btn-primary:hover {
            background: #1e4a7c;
        }

        .btn-secondary {
            background: var(--surface);
            color: var(--ink);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .controls-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .mode-selector {
            margin-bottom: 15px;
        }

        .mode-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .mode-btn {
            flex: 1;
            min-width: 200px;
            padding: 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .mode-btn:hover {
            border-color: var(--brand);
            background: #f8f9fa;
        }

        .mode-btn.active {
            border-color: var(--brand);
            background: var(--brand);
            color: white;
        }

        .mode-btn.active .mode-desc {
            color: rgba(255, 255, 255, 0.8);
        }

        .mode-desc {
            display: block;
            font-size: 0.85rem;
            color: var(--ink-muted);
            margin-top: 5px;
            font-weight: normal;
        }

        /* ==========================
           –°–¢–ê–¢–ò–°–¢–ò–ö–ê
           ========================== */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 15px;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--ink-muted);
            font-size: 0.9rem;
        }

        .stat-success .stat-number {
            color: var(--success);
        }

        .stat-error .stat-number {
            color: var(--error);
        }

        .stat-warning .stat-number {
            color: var(--warning);
        }

        /* ==========================
           –ü–†–û–ì–†–ï–° –ë–ê–†
           ========================== */
        .progress-section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: var(--border);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--brand), #4f86c6);
            width: 0%;
            transition: width 0.3s;
        }

        .progress-text {
            text-align: center;
            font-size: 0.9rem;
            color: var(--ink-muted);
        }

        /* ==========================
           –†–ï–ó–£–õ–¢–ê–¢–ò
           ========================== */
        .results-section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .results-header {
            background: var(--border);
            padding: 15px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .filters {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 6px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .filter-btn.active {
            background: var(--brand);
            color: white;
            border-color: var(--brand);
        }

        .filter-separator {
            color: var(--ink-muted);
            font-weight: bold;
            user-select: none;
        }

        .results-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .link-item {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .link-item:last-child {
            border-bottom: none;
        }

        .status-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
        }

        .status-success {
            background: var(--success);
        }

        .status-error {
            background: var(--error);
        }

        .status-pending {
            background: var(--warning);
        }

        .link-content {
            flex: 1;
            min-width: 0;
        }

        .link-url {
            font-family: monospace;
            font-size: 0.9rem;
            word-break: break-all;
            margin-bottom: 5px;
        }

        .link-info {
            display: flex;
            gap: 15px;
            font-size: 0.85rem;
            color: var(--ink-muted);
            flex-wrap: wrap;
        }

        .link-source {
            font-style: italic;
        }

        .link-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 4px 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .action-btn:hover {
            background: var(--surface);
        }

        /* ==========================
           –°–™–û–ë–©–ï–ù–ò–Ø
           ========================== */
        .message {
            padding: 15px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            border: 1px solid;
        }

        .message-success {
            background: #f0fdf4;
            border-color: var(--success);
            color: #166534;
        }

        .message-error {
            background: #fef2f2;
            border-color: var(--error);
            color: #991b1b;
        }

        .message-warning {
            background: #fffbeb;
            border-color: var(--warning);
            color: #92400e;
        }

        .hidden {
            display: none;
        }

        /* ==========================
           ANALYSIS SECTION
           ========================== */
        .analysis-section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .analysis-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .analysis-header h3 {
            color: var(--brand);
            margin: 0 0 5px;
            font-size: 1.4rem;
        }

        .analysis-subtitle {
            color: var(--ink-muted);
            margin: 0;
            font-size: 0.9rem;
        }

        .link-summary {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .summary-total {
            text-align: center;
        }

        .total-number {
            font-size: 3rem;
            font-weight: bold;
            color: var(--brand);
            line-height: 1;
        }

        .total-label {
            color: var(--ink-muted);
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .summary-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            min-width: 300px;
        }

        .breakdown-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 6px;
        }

        .breakdown-icon {
            font-size: 1.2rem;
        }

        .breakdown-text {
            font-size: 0.85rem;
            color: var(--ink-muted);
        }

        .breakdown-count {
            font-weight: bold;
            color: var(--ink);
            margin-left: auto;
        }

        .type-selection {
            border-top: 1px solid var(--border);
            padding-top: 20px;
        }

        .type-selection h4 {
            color: var(--brand);
            margin: 0 0 15px;
            font-size: 1.1rem;
        }

        .type-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .type-btn {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .type-btn:hover {
            border-color: var(--brand);
            background: #f8f9fa;
        }

        .type-btn.selected {
            border-color: var(--brand);
            background: var(--brand);
            color: white;
        }

        .type-btn.selected .type-count {
            color: rgba(255, 255, 255, 0.8);
        }

        .type-count {
            font-weight: bold;
            color: var(--ink);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* ==========================
           RESPONSIVE
           ========================== */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .url-input-group {
                flex-direction: column;
            }

            .url-input {
                min-width: 100%;
            }

            .stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .link-summary {
                flex-direction: column;
                gap: 20px;
            }

            .summary-breakdown {
                min-width: 100%;
            }

            .type-buttons {
                grid-template-columns: 1fr;
            }

            .results-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .link-item {
                flex-direction: column;
                gap: 8px;
            }

            .link-actions {
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üîó Blogspot Link Checker - Server Edition</h1>
            <p class="subtitle">–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤—Å–∏—á–∫–∏ –ª–∏–Ω–∫–æ–≤–µ –æ—Ç Blogspot —Å–∞–π—Ç —á—Ä–µ–∑ –ª–æ–∫–∞–ª–µ–Ω Node.js —Å—ä—Ä–≤—ä—Ä</p>
            <div id="server-status" class="server-status offline">
                <span id="status-icon">‚≠ï</span>
                <span id="status-text">–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—ä—Ä–≤—ä—Ä...</span>
            </div>
        </header>

        <div id="message-container"></div>

        <section class="control-panel">
            <div class="url-input-group">
                <input type="url" id="blogspot-url" class="url-input"
                       placeholder="https://your-blog.blogspot.com"
                       value="https://www.lichna-prizma.eu/">
                <button id="check-btn" class="btn btn-primary">üîç –ü—Ä–æ–≤–µ—Ä–∏ –ª–∏–Ω–∫–æ–≤–µ—Ç–µ</button>
            </div>



            <div class="controls-row">
                <button id="refresh-broken-btn" class="btn btn-secondary hidden">üîÑ –û–±–Ω–æ–≤–∏ —Å—á—É–ø–µ–Ω–∏—Ç–µ</button>
                <button id="copy-broken-btn" class="btn btn-secondary hidden">üìã –ö–æ–ø–∏—Ä–∞–π —Å—á—É–ø–µ–Ω–∏—Ç–µ</button>
                <button id="clear-btn" class="btn btn-secondary">üóëÔ∏è –ò–∑—á–∏—Å—Ç–∏</button>
            </div>
        </section>

        <!-- ANALYSIS SECTION - Shows link overview before checking -->
        <section id="analysis-section" class="analysis-section hidden">
            <div class="analysis-header">
                <h3>üìã –ù–ê–ú–ï–†–ï–ù–ò –õ–ò–ù–ö–û–í–ï</h3>
                <p class="analysis-subtitle">–ò–∑–±–µ—Ä–µ—Ç–µ –∫–æ–∏ —Ç–∏–ø–æ–≤–µ –ª–∏–Ω–∫–æ–≤–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç–µ</p>
            </div>

            <div class="link-summary">
                <div class="summary-total">
                    <div class="total-number" id="analysis-total">0</div>
                    <div class="total-label">–û–±—â–æ –ª–∏–Ω–∫–æ–≤–µ</div>
                </div>

                <div class="summary-breakdown" id="analysis-breakdown">
                    <!-- Link type counts will be populated here -->
                </div>
            </div>

            <div class="type-selection">
                <h4>üéØ –ò–∑–±–µ—Ä–µ—Ç–µ —Ç–∏–ø–æ–≤–µ –∑–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞:</h4>
                <div class="type-buttons" id="type-buttons">
                    <button class="type-btn selected" data-type="all">
                        ‚úÖ –í—Å–∏—á–∫–∏ –ª–∏–Ω–∫–æ–≤–µ
                        <span class="type-count" id="type-count-all">0</span>
                    </button>
                    <button class="type-btn" data-type="image">
                        üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                        <span class="type-count" id="type-count-image">0</span>
                    </button>
                    <button class="type-btn" data-type="video">
                        üé¨ –í–∏–¥–µ–æ
                        <span class="type-count" id="type-count-video">0</span>
                    </button>
                    <button class="type-btn" data-type="webpage">
                        üåê –£–µ–± —Å—Ç—Ä–∞–Ω–∏—Ü–∏
                        <span class="type-count" id="type-count-webpage">0</span>
                    </button>
                    <button class="type-btn" data-type="document">
                        üìÑ –î–æ–∫—É–º–µ–Ω—Ç–∏
                        <span class="type-count" id="type-count-document">0</span>
                    </button>
                    <button class="type-btn" data-type="youtube">
                        üé• YouTube
                        <span class="type-count" id="type-count-youtube">0</span>
                    </button>
                </div>

                <div class="action-buttons">
                    <button id="start-checking-btn" class="btn btn-primary">üöÄ –ó–∞–ø–æ—á–Ω–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞</button>
                    <button id="restart-analysis-btn" class="btn btn-secondary">üîÑ –ò–∑–±–µ—Ä–∏ –æ—Ç–Ω–æ–≤–æ</button>
                </div>
            </div>
        </section>

        <section id="stats-section" class="hidden">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-count">0</div>
                    <div class="stat-label">–û–±—â–æ –ª–∏–Ω–∫–æ–≤–µ</div>
                </div>
                <div class="stat-card stat-success">
                    <div class="stat-number" id="success-count">0</div>
                    <div class="stat-label">–†–∞–±–æ—Ç–µ—â–∏</div>
                </div>
                <div class="stat-card stat-error">
                    <div class="stat-number" id="error-count">0</div>
                    <div class="stat-label">–°—á—É–ø–µ–Ω–∏</div>
                </div>
                <div class="stat-card stat-warning">
                    <div class="stat-number" id="pending-count">0</div>
                    <div class="stat-label">–ü—Ä–æ–≤–µ—Ä—è–≤–∞—Ç —Å–µ</div>
                </div>
            </div>
        </section>

        <section id="progress-section" class="progress-section hidden">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="progress-text" id="progress-text">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...</div>
        </section>

        <section id="results-section" class="results-section hidden">
            <div class="results-header">
                <h3>–†–µ–∑—É–ª—Ç–∞—Ç–∏ –æ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∞—Ç–∞</h3>
                <div class="filters">
                    <button class="filter-btn active" data-filter="all">üìã –í—Å–∏—á–∫–∏</button>
                    <button class="filter-btn" data-filter="success">‚úÖ –†–∞–±–æ—Ç–µ—â–∏</button>
                    <button class="filter-btn" data-filter="error">‚ùå –°—á—É–ø–µ–Ω–∏</button>
                    <button class="filter-btn" data-filter="pending">‚è≥ –ü—Ä–æ–≤–µ—Ä—è–≤–∞—Ç —Å–µ</button>
                    <span class="filter-separator">|</span>
                    <button class="filter-btn" data-filter="image">üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</button>
                    <button class="filter-btn" data-filter="video">üé¨ –í–∏–¥–µ–æ</button>
                    <button class="filter-btn" data-filter="webpage">üåê –£–µ–± —Å—Ç—Ä–∞–Ω–∏—Ü–∏</button>
                    <button class="filter-btn" data-filter="document">üìÑ –î–æ–∫—É–º–µ–Ω—Ç–∏</button>
                    <button class="filter-btn" data-filter="youtube">üé• YouTube</button>
                </div>
            </div>
            <div class="results-list" id="results-list"></div>
        </section>
    </div>

    <script>
        // ==========================
        // –ì–õ–û–ë–ê–õ–ù–ò –ü–†–û–ú–ï–ù–õ–ò–í–ò
        // ==========================
        let allLinks = [];
        let currentFilter = 'all';
        let isChecking = false;
        let appState = 'idle'; // 'idle' | 'analysis' | 'checking'
        let selectedTypes = ['all']; // –ò–∑–±—Ä–∞–Ω–∏—Ç–µ —Ç–∏–ø–æ–≤–µ –∑–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞
        let serverOnline = false;

        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞—Ç–∞
        const CHECK_CONFIG = {
            maxPosts: 500, // –ú–æ–∂–µ –¥–∞ —Å–µ —É–≤–µ–ª–∏—á–∏ –∞–∫–æ –µ –Ω—É–∂–Ω–æ
            maxLinks: Infinity, // –û–±—Ä–∞–±–æ—Ç–≤–∞ –≤—Å–∏—á–∫–∏ –Ω–∞–º–µ—Ä–µ–Ω–∏ –ª–∏–Ω–∫–æ–≤–µ
            batchSize: 5,
            requestTimeout: 15000,
            batchDelay: 1500,
            methodRetryDelay: 1000
        };

        // –¢–∏–ø–æ–≤–µ –ª–∏–Ω–∫–æ–≤–µ —Å –∏–∫–æ–Ω–∫–∏ –∏ —Ñ–∏–ª—Ç—Ä–∏
        const LINK_TYPES = {
            all: { label: '–í—Å–∏—á–∫–∏', icon: 'üìã', filter: () => true },
            image: { label: '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', icon: 'üñºÔ∏è', filter: link => link.type === 'image' },
            video: { label: '–í–∏–¥–µ–æ', icon: 'üé¨', filter: link => link.type === 'video' },
            audio: { label: '–ê—É–¥–∏–æ', icon: 'üéµ', filter: link => link.type === 'audio' },
            webpage: { label: '–£–µ–± —Å—Ç—Ä–∞–Ω–∏—Ü–∏', icon: 'üåê', filter: link => link.type === 'webpage' },
            document: { label: '–î–æ–∫—É–º–µ–Ω—Ç–∏', icon: 'üìÑ', filter: link => link.type === 'document' },
            youtube: { label: 'YouTube', icon: 'üé•', filter: link => link.type === 'youtube' },
            vimeo: { label: 'Vimeo', icon: 'üéûÔ∏è', filter: link => link.type === 'vimeo' },
            unknown: { label: '–ù–µ–ø–æ–∑–Ω–∞—Ç–∏', icon: '‚ùì', filter: link => link.type === 'unknown' }
        };

        // ==========================
        // SERVER COMMUNICATION
        // ==========================
        const SERVER_BASE_URL = 'http://localhost:3000';

        async function checkServerHealth() {
            try {
                const response = await fetch(`${SERVER_BASE_URL}/health`, {
                    timeout: 3000
                });
                const data = await response.json();

                if (data.status === 'ok') {
                    serverOnline = true;
                    updateServerStatus(true, '–°—ä—Ä–≤—ä—Ä—ä—Ç —Ä–∞–±–æ—Ç–∏');
                    return true;
                }
            } catch (error) {
                console.warn('Server health check failed:', error);
            }

            serverOnline = false;
            updateServerStatus(false, '–°—ä—Ä–≤—ä—Ä—ä—Ç –Ω–µ –µ –¥–æ—Å—Ç—ä–ø–µ–Ω');
            return false;
        }

        function updateServerStatus(online, message) {
            const statusEl = document.getElementById('server-status');
            const iconEl = document.getElementById('status-icon');
            const textEl = document.getElementById('status-text');

            if (online) {
                statusEl.className = 'server-status online';
                iconEl.textContent = 'üü¢';
            } else {
                statusEl.className = 'server-status offline';
                iconEl.textContent = 'üî¥';
            }

            textEl.textContent = message;
        }

        async function checkLinkViaServer(link) {
            const startTime = Date.now();

            try {
                const response = await fetch(`${SERVER_BASE_URL}/check?url=${encodeURIComponent(link.url)}`, {
                    timeout: CHECK_CONFIG.requestTimeout
                });

                if (!response.ok) {
                    throw new Error(`Server responded with ${response.status}`);
                }

                const data = await response.json();
                const responseTime = Date.now() - startTime;

                // Enhanced success validation based on server response
                const isSuccess = isValidSuccessStatus(data.status, link.url, data);

                return {
                    ...link,
                    status: isSuccess ? 'success' : 'error',
                    statusCode: data.status,
                    responseTime: data.responseTime,
                    method: `server-${data.method}`,
                    serverData: data,
                    note: data.statusText || (data.error ? `Error: ${data.error}` : null)
                };

            } catch (error) {
                return {
                    ...link,
                    status: 'error',
                    statusCode: null,
                    responseTime: Date.now() - startTime,
                    error: error.message,
                    method: 'server-error'
                };
            }
        }

        // ==========================
        // DOM –ï–õ–ï–ú–ï–ù–¢–ò
        // ==========================
        const elements = {
            blogspotUrl: document.getElementById('blogspot-url'),
            checkBtn: document.getElementById('check-btn'),
            refreshBrokenBtn: document.getElementById('refresh-broken-btn'),
            copyBrokenBtn: document.getElementById('copy-broken-btn'),
            clearBtn: document.getElementById('clear-btn'),
            messageContainer: document.getElementById('message-container'),
            statsSection: document.getElementById('stats-section'),
            progressSection: document.getElementById('progress-section'),
            resultsSection: document.getElementById('results-section'),
            totalCount: document.getElementById('total-count'),
            successCount: document.getElementById('success-count'),
            errorCount: document.getElementById('error-count'),
            pendingCount: document.getElementById('pending-count'),
            progressFill: document.getElementById('progress-fill'),
            progressText: document.getElementById('progress-text'),
            resultsList: document.getElementById('results-list')
        };

        // ==========================
        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
        // ==========================
        async function init() {
            // Check server status on load
            await checkServerHealth();

            // Check server status every 30 seconds
            setInterval(checkServerHealth, 30000);

            elements.checkBtn.addEventListener('click', startChecking);
            elements.refreshBrokenBtn.addEventListener('click', refreshBrokenLinks);
            elements.copyBrokenBtn.addEventListener('click', copyBrokenLinks);
            elements.clearBtn.addEventListener('click', clearResults);

            // Analysis section buttons
            document.getElementById('start-checking-btn').addEventListener('click', startActualChecking);
            document.getElementById('restart-analysis-btn').addEventListener('click', restartAnalysis);

            // Type selection buttons
            document.querySelectorAll('.type-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const type = e.target.closest('.type-btn').dataset.type;
                    handleTypeSelection(type);
                });
            });

            // Filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    currentFilter = e.target.dataset.filter;
                    renderResults();
                });
            });

            // Enter key support
            elements.blogspotUrl.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !isChecking) {
                    startChecking();
                }
            });
        }

        // ==========================
        // LINK TYPE DETECTION
        // ==========================
        function detectLinkType(url) {
            // Images
            if (url.match(/\.(jpg|jpeg|png|gif|webp|svg|bmp|ico|tiff|avif)$/i)) {
                return 'image';
            }

            // Videos
            if (url.match(/\.(mp4|avi|mov|webm|mkv|flv|wmv|mpg|mpeg|m4v|3gp)$/i)) {
                return 'video';
            }

            // Audio
            if (url.match(/\.(mp3|wav|flac|aac|ogg|m4a|wma|opus)$/i)) {
                return 'audio';
            }

            // Documents
            if (url.match(/\.(pdf|doc|docx|xls|xlsx|ppt|pptx|txt|rtf|odt|ods|odp)$/i)) {
                return 'document';
            }

            // YouTube
            if (url.includes('youtube.com') || url.includes('youtu.be')) {
                return 'youtube';
            }

            // Vimeo
            if (url.includes('vimeo.com')) {
                return 'vimeo';
            }

            // Blogger images
            if (url.includes('blogger.googleusercontent.com') || url.includes('googleusercontent.com')) {
                return 'image';
            }

            // General web pages (HTTP/HTTPS URLs)
            if (url.startsWith('http')) {
                return 'webpage';
            }

            return 'unknown';
        }

        // ==========================
        // –û–°–ù–û–í–ù–ò –§–£–ù–ö–¶–ò–ò
        // ==========================
        function showMessage(text, type = 'info') {
            const className = type === 'error' ? 'message-error' :
                           type === 'warning' ? 'message-warning' : 'message-success';
            elements.messageContainer.innerHTML = `<div class="message ${className}">${text}</div>`;

            // Auto-hide after 5 seconds
            setTimeout(() => {
                elements.messageContainer.innerHTML = '';
            }, 5000);
        }

        function updateStats() {
            const total = allLinks.length;
            const success = allLinks.filter(l => l.status === 'success').length;
            const error = allLinks.filter(l => l.status === 'error').length;
            const pending = allLinks.filter(l => l.status === 'pending').length;

            elements.totalCount.textContent = total;
            elements.successCount.textContent = success;
            elements.errorCount.textContent = error;
            elements.pendingCount.textContent = pending;
        }

        function updateProgress(current, total) {
            const percentage = total > 0 ? (current / total) * 100 : 0;
            elements.progressFill.style.width = `${percentage}%`;
            elements.progressText.textContent = `–ü—Ä–æ–≤–µ—Ä–∫–∞: ${current} / ${total} –ª–∏–Ω–∫–∞ (${Math.round(percentage)}%)`;
        }

        // ==========================
        // BLOGSPOT API
        // ==========================
        async function fetchBlogspotData(url) {
            const cleanUrl = url.replace(/\/$/, '');
            const callbackName = 'jsonpCallback' + Date.now();
            const script = document.createElement('script');

            return new Promise((resolve, reject) => {
                window[callbackName] = (json) => {
                    if (!json.feed || !json.feed.entry) {
                        reject(new Error('–ù–µ–≤–∞–ª–∏–¥–µ–Ω —Ñ–æ—Ä–º–∞—Ç –Ω–∞ –¥–∞–Ω–Ω–∏—Ç–µ –æ—Ç Blogger'));
                        return;
                    }

                    const posts = json.feed.entry.map(entry => {
                        const id = entry.id.$t.split('.post-')[1];
                        const linkObj = entry.link.find(l => l.rel === 'alternate');
                        const url = linkObj ? linkObj.href : null;
                        const content = entry.content ? entry.content.$t : '';
                        const title = entry.title.$t;

                        return {
                            id: id,
                            title: title,
                            url: url,
                            content: content,
                            date: entry.published.$t.slice(0, 10)
                        };
                    });

                    resolve(posts);
                    delete window[callbackName];
                    document.head.removeChild(script);
                };

                const maxResults = CHECK_CONFIG.maxPosts;
                script.src = `${cleanUrl}/feeds/posts/default?alt=json-in-script&callback=${callbackName}&max-results=${maxResults}`;
                script.onerror = () => {
                    reject(new Error('–ù–µ—É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –¥–∞–Ω–Ω–∏—Ç–µ –æ—Ç Blogger'));
                    delete window[callbackName];
                    document.head.removeChild(script);
                };

                document.head.appendChild(script);
            });
        }

        // ==========================
        // –õ–ò–ù–ö –ü–ê–†–°–ï–†
        // ==========================
        function extractLinksFromPosts(posts) {
            const links = new Map();
            const urlRegex = /https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_\+.~#?&//=]*)/g;

            posts.forEach(post => {
                // Extract all URLs from content
                const urls = post.content.match(urlRegex) || [];

                // Also extract from <a> and <img> tags more reliably
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = post.content;

                // Get links from <a> tags
                tempDiv.querySelectorAll('a[href]').forEach(a => {
                    const href = a.getAttribute('href');
                    if (href && (href.startsWith('http://') || href.startsWith('https://'))) {
                        urls.push(href);
                    }
                });

                // Get links from <img> tags
                tempDiv.querySelectorAll('img[src]').forEach(img => {
                    const src = img.getAttribute('src');
                    if (src && (src.startsWith('http://') || src.startsWith('https://'))) {
                        urls.push(src);
                    }
                });

                // Get links from <iframe> tags
                tempDiv.querySelectorAll('iframe[src]').forEach(iframe => {
                    const src = iframe.getAttribute('src');
                    if (src && (src.startsWith('http://') || src.startsWith('https://'))) {
                        urls.push(src);
                    }
                });

                urls.forEach(url => {
                    try {
                        const cleanUrl = new URL(url).href;
                        if (!links.has(cleanUrl)) {
                            links.set(cleanUrl, {
                                url: cleanUrl,
                                status: 'pending',
                                statusCode: null,
                                responseTime: null,
                                source: post.title,
                                sourceUrl: post.url,
                                type: detectLinkType(cleanUrl) // –î–æ–±–∞–≤—è–º–µ —Ç–∏–ø –Ω–∞ –ª–∏–Ω–∫–∞
                            });
                        }
                    } catch (e) {
                        // Invalid URL, skip
                    }
                });
            });

            // Return all found links (no limits)
            return Array.from(links.values());
        }

        // ==========================
        // LINK CHECKER
        // ==========================
        async function checkLink(link) {
            // Check if server is online
            if (!serverOnline) {
                return {
                    ...link,
                    status: 'error',
                    statusCode: null,
                    responseTime: 0,
                    error: '–õ–æ–∫–∞–ª–Ω–∏—è—Ç —Å—ä—Ä–≤—ä—Ä –Ω–µ –µ –¥–æ—Å—Ç—ä–ø–µ–Ω',
                    method: 'server-offline'
                };
            }

            return await checkLinkViaServer(link);
        }

        function isValidSuccessStatus(statusCode, url, serverData) {
            // More lenient criteria for success
            if (statusCode >= 200 && statusCode < 300) {
                return true; // Standard success codes
            }

            // 403 Forbidden is often a false positive for working sites
            if (statusCode === 403) {
                return true;
            }

            // 401 Unauthorized but some sites work
            if (statusCode === 401) {
                return true;
            }

            // If we get any content at all, consider it successful
            if (serverData && (serverData.hasContent || serverData.contentLength > 0)) {
                return true;
            }

            return false;
        }

        async function checkLinksBatch(links) {
            const batches = [];

            for (let i = 0; i < links.length; i += CHECK_CONFIG.batchSize) {
                batches.push(links.slice(i, i + CHECK_CONFIG.batchSize));
            }

            let checkedCount = 0;

            for (const batch of batches) {
                const promises = batch.map(link => checkLink(link));
                const results = await Promise.allSettled(promises);

                results.forEach((result, index) => {
                    const linkIndex = links.indexOf(batch[index]);
                    if (result.status === 'fulfilled') {
                        allLinks[linkIndex] = result.value;
                    } else {
                        allLinks[linkIndex] = {
                            ...batch[index],
                            status: 'error',
                            statusCode: null,
                            error: 'Check failed'
                        };
                    }
                });

                checkedCount += batch.length;
                updateProgress(checkedCount, links.length);
                updateStats();
                renderResults();

                // Delay between batches
                if (CHECK_CONFIG.batchDelay > 0) {
                    await new Promise(resolve => setTimeout(resolve, CHECK_CONFIG.batchDelay));
                }
            }
        }

        // ==========================
        // UI –§–£–ù–ö–¶–ò–ò
        // ==========================
        function renderResults() {
            const filteredLinks = allLinks.filter(link => {
                if (currentFilter === 'all') return true;

                // Check if it's a status filter (success, error, pending)
                if (['success', 'error', 'pending'].includes(currentFilter)) {
                    return link.status === currentFilter;
                }

                // Check if it's a type filter (image, video, webpage, etc.)
                if (LINK_TYPES[currentFilter]) {
                    return LINK_TYPES[currentFilter].filter(link);
                }

                return false;
            });

            if (filteredLinks.length === 0) {
                elements.resultsList.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--ink-muted);">–ù—è–º–∞ –ª–∏–Ω–∫–æ–≤–µ –∑–∞ –ø–æ–∫–∞–∑–≤–∞–Ω–µ —Å —Ç–µ–∫—É—â–∏—è —Ñ–∏–ª—Ç—ä—Ä.</div>';
                return;
            }

            elements.resultsList.innerHTML = filteredLinks.map(link => {
                const statusClass = `status-${link.status}`;
                const statusIcon = link.status === 'success' ? '‚úì' :
                                link.status === 'error' ? '‚úó' : '‚è≥';

                const statusCodeText = link.statusCode ? `HTTP ${link.statusCode}` : '';
                const responseTimeText = link.responseTime ? `${link.responseTime}ms` : '';
                const methodText = link.method ? `<span>üîß ${link.method}</span>` : '';
                const noteText = link.note ? `<span>üìù ${link.note}</span>` : '';

                // Get type icon and label
                const typeInfo = LINK_TYPES[link.type] || LINK_TYPES.unknown;
                const typeText = `<span>${typeInfo.icon} ${typeInfo.label}</span>`;

                return `
                    <div class="link-item">
                        <div class="status-icon ${statusClass}">${statusIcon}</div>
                        <div class="link-content">
                            <div class="link-url">${escapeHtml(link.url)}</div>
                            <div class="link-info">
                                <span class="link-source">üìÑ ${escapeHtml(link.source)}</span>
                                ${typeText ? typeText : ''}
                                ${statusCodeText ? `<span>üî¢ ${statusCodeText}</span>` : ''}
                                ${responseTimeText ? `<span>‚è±Ô∏è ${responseTimeText}</span>` : ''}
                                ${methodText ? methodText : ''}
                                ${noteText ? noteText : ''}
                                ${link.error ? `<span style="color: var(--error)">‚ö†Ô∏è ${escapeHtml(link.error)}</span>` : ''}
                            </div>
                        </div>
                        <div class="link-actions">
                            <button class="action-btn" onclick="window.open('${escapeHtml(link.url)}', '_blank')">üîó</button>
                            ${link.status === 'error' ? `<button class="action-btn" onclick="recheckLink('${link.url}')">üîÑ</button>` : ''}
                            ${link.status === 'success' && link.method ? `<button class="action-btn" onclick="showMethodInfo('${escapeHtml(link.method)}', '${escapeHtml(link.url)}')">‚ÑπÔ∏è</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==========================
        // –î–û–ü–û–õ–ù–ò–¢–ï–õ–ù–ò –§–£–ù–ö–¶–ò–ò
        // ==========================
        async function recheckLink(url) {
            const linkIndex = allLinks.findIndex(l => l.url === url);
            if (linkIndex === -1) return;

            const link = allLinks[linkIndex];
            allLinks[linkIndex] = { ...link, status: 'pending', statusCode: null, responseTime: null, error: null };

            updateStats();
            renderResults();

            try {
                const result = await checkLink(link);
                allLinks[linkIndex] = result;
                updateStats();
                renderResults();

                if (result.status === 'success') {
                    showMessage(`–õ–∏–Ω–∫—ä—Ç –µ –ø–æ–≤—Ç–æ—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω —É—Å–ø–µ—à–Ω–æ`, 'success');
                } else {
                    showMessage(`–õ–∏–Ω–∫—ä—Ç –≤—Å–µ –æ—â–µ –µ —Å—á—É–ø–µ–Ω`, 'warning');
                }
            } catch (error) {
                allLinks[linkIndex] = { ...link, status: 'error', error: error.message };
                updateStats();
                renderResults();
                showMessage(`–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞: ${error.message}`, 'error');
            }
        }

        function showMethodInfo(method, url) {
            const methodInfo = {
                'server-HEAD': '–î–∏—Ä–µ–∫—Ç–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —á—Ä–µ–∑ –ª–æ–∫–∞–ª–Ω–∏—è —Å—ä—Ä–≤—ä—Ä (HEAD request)',
                'server-GET': '–î–∏—Ä–µ–∫—Ç–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —á—Ä–µ–∑ –ª–æ–∫–∞–ª–Ω–∏—è —Å—ä—Ä–≤—ä—Ä (GET fallback)',
                'server-error': '–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∫–æ–º—É–Ω–∏–∫–∞—Ü–∏—è —Å—ä—Å —Å—ä—Ä–≤—ä—Ä–∞'
            };

            const info = methodInfo[method] || `–ú–µ—Ç–æ–¥: ${method}`;
            showMessage(`üîß ${info}\nüìé URL: ${url}`, 'info');
        }

        // ==========================
        // ANALYSIS FUNCTIONS
        // ==========================
        function showLinkAnalysis() {
            // Calculate link type statistics
            const typeStats = {};
            allLinks.forEach(link => {
                typeStats[link.type] = (typeStats[link.type] || 0) + 1;
            });

            // Update total count
            document.getElementById('analysis-total').textContent = allLinks.length;

            // Update individual type counts
            Object.keys(LINK_TYPES).forEach(type => {
                const countEl = document.getElementById(`type-count-${type}`);
                if (countEl) {
                    countEl.textContent = typeStats[type] || 0;
                }
            });

            // Create breakdown items
            const breakdownEl = document.getElementById('analysis-breakdown');
            const breakdownItems = [];

            Object.entries(LINK_TYPES).forEach(([type, info]) => {
                if (type !== 'all') {
                    const count = typeStats[type] || 0;
                    if (count > 0) {
                        breakdownItems.push(`
                            <div class="breakdown-item">
                                <span class="breakdown-icon">${info.icon}</span>
                                <span class="breakdown-text">${info.label}</span>
                                <span class="breakdown-count">${count}</span>
                            </div>
                        `);
                    }
                }
            });

            breakdownEl.innerHTML = breakdownItems.join('');

            // Show analysis section
            document.getElementById('analysis-section').classList.remove('hidden');
            appState = 'analysis';
        }

        function handleTypeSelection(type) {
            // Update selected types
            if (type === 'all') {
                selectedTypes = ['all'];
            } else {
                if (selectedTypes.includes('all')) {
                    selectedTypes = [];
                }
                if (selectedTypes.includes(type)) {
                    selectedTypes = selectedTypes.filter(t => t !== type);
                    if (selectedTypes.length === 0) {
                        selectedTypes = ['all'];
                    }
                } else {
                    selectedTypes.push(type);
                }
            }

            // Update UI
            document.querySelectorAll('.type-btn').forEach(btn => {
                const btnType = btn.dataset.type;
                if (selectedTypes.includes(btnType) || (btnType === 'all' && selectedTypes.includes('all'))) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            });
        }

        function restartAnalysis() {
            appState = 'idle';
            document.getElementById('analysis-section').classList.add('hidden');
            selectedTypes = ['all'];

            // Reset type buttons
            document.querySelectorAll('.type-btn').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.dataset.type === 'all') {
                    btn.classList.add('selected');
                }
            });
        }

        function getLinksToCheck() {
            if (selectedTypes.includes('all')) {
                return [...allLinks];
            }

            return allLinks.filter(link => selectedTypes.includes(link.type));
        }

        // ==========================
        // –û–°–ù–û–í–ù–ò –ö–û–ù–¢–†–û–õ–ò
        // ==========================
        async function startChecking() {
            if (isChecking || appState !== 'idle') return;

            // Check server status before starting
            const serverOk = await checkServerHealth();
            if (!serverOk) {
                showMessage('‚ùå –õ–æ–∫–∞–ª–Ω–∏—è—Ç —Å—ä—Ä–≤—ä—Ä –Ω–µ –µ –¥–æ—Å—Ç—ä–ø–µ–Ω. –°—Ç–∞—Ä—Ç–∏—Ä–∞–π—Ç–µ: node server.js', 'error');
                return;
            }

            const url = elements.blogspotUrl.value.trim();
            if (!url) {
                showMessage('–ú–æ–ª—è, –≤—ä–≤–µ–¥–µ—Ç–µ –≤–∞–ª–∏–¥–µ–Ω Blogspot URL', 'error');
                return;
            }

            isChecking = true;
            elements.checkBtn.disabled = true;
            elements.checkBtn.textContent = '‚è≥ –ê–Ω–∞–ª–∏–∑–∏—Ä–∞–Ω–µ...';

            try {
                // Fetch posts
                const posts = await fetchBlogspotData(url);

                if (posts.length === 0) {
                    showMessage('–ù–µ —Å–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ —É–∫–∞–∑–∞–Ω–∏—è –±–ª–æ–≥', 'warning');
                    return;
                }

                // Extract links
                allLinks = extractLinksFromPosts(posts);

                if (allLinks.length === 0) {
                    showMessage('–ù–µ —Å–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏ –ª–∏–Ω–∫–æ–≤–µ –≤ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏—Ç–µ', 'warning');
                    return;
                }

                showMessage(`–ù–∞–º–µ—Ä–µ–Ω–∏ —Å–∞ ${allLinks.length} –ª–∏–Ω–∫–∞ –∑–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞`, 'info');

                // Show analysis instead of directly checking
                showLinkAnalysis();

            } catch (error) {
                console.error('Error:', error);
                showMessage(`–ì—Ä–µ—à–∫–∞: ${error.message}`, 'error');
            } finally {
                isChecking = false;
                elements.checkBtn.disabled = false;
                elements.checkBtn.textContent = 'üîç –ü—Ä–æ–≤–µ—Ä–∏ –ª–∏–Ω–∫–æ–≤–µ—Ç–µ';
            }
        }

        async function startActualChecking() {
            if (isChecking || appState !== 'analysis') return;

            const linksToCheck = getLinksToCheck();
            if (linksToCheck.length === 0) {
                showMessage('–ù—è–º–∞ –ª–∏–Ω–∫–æ–≤–µ –∑–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å –∏–∑–±—Ä–∞–Ω–∏—Ç–µ —Ç–∏–ø–æ–≤–µ', 'warning');
                return;
            }

            appState = 'checking';
            isChecking = true;

            // Hide analysis, show checking UI
            document.getElementById('analysis-section').classList.add('hidden');
            elements.statsSection.classList.remove('hidden');
            elements.progressSection.classList.remove('hidden');

            // Update button
            document.getElementById('start-checking-btn').disabled = true;
            document.getElementById('start-checking-btn').textContent = 'üöÄ –ü—Ä–æ–≤–µ—Ä—è–≤–∞ —Å–µ...';

            try {
                showMessage(`–ó–∞–ø–æ—á–≤–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ ${linksToCheck.length} –ª–∏–Ω–∫–∞...`, 'info');

                // Reset status for links to be checked
                linksToCheck.forEach(link => {
                    link.status = 'pending';
                    link.statusCode = null;
                    link.responseTime = null;
                    link.error = null;
                });

                updateStats();
                renderResults();

                // Start checking
                await checkLinksBatch(linksToCheck);

                // Show control buttons
                elements.refreshBrokenBtn.classList.remove('hidden');
                elements.copyBrokenBtn.classList.remove('hidden');
                elements.resultsSection.classList.remove('hidden');

                const errorCount = allLinks.filter(l => l.status === 'error').length;

                if (errorCount > 0) {
                    showMessage(`–ü—Ä–æ–≤–µ—Ä–∫–∞—Ç–∞ –∑–∞–≤—ä—Ä—à–∏! –ù–∞–º–µ—Ä–µ–Ω–∏ —Å–∞ ${errorCount} —Å—á—É–ø–µ–Ω–∏ –ª–∏–Ω–∫–∞.`, 'warning');
                } else {
                    showMessage('–ü—Ä–æ–≤–µ—Ä–∫–∞—Ç–∞ –∑–∞–≤—ä—Ä—à–∏! –í—Å–∏—á–∫–∏ –ª–∏–Ω–∫–æ–≤–µ —Ä–∞–±–æ—Ç—è—Ç –∫–æ—Ä–µ–∫—Ç–Ω–æ.', 'success');
                }

            } catch (error) {
                console.error('Error:', error);
                showMessage(`–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞—Ç–∞: ${error.message}`, 'error');
            } finally {
                isChecking = false;
                document.getElementById('start-checking-btn').disabled = false;
                document.getElementById('start-checking-btn').textContent = 'üöÄ –ó–∞–ø–æ—á–Ω–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞';
            }
        }

        async function refreshBrokenLinks() {
            const brokenLinks = allLinks.filter(l => l.status === 'error');
            if (brokenLinks.length === 0) {
                showMessage('–ù—è–º–∞ —Å—á—É–ø–µ–Ω–∏ –ª–∏–Ω–∫–æ–≤–µ –∑–∞ –æ–±–Ω–æ–≤—è–≤–∞–Ω–µ', 'info');
                return;
            }

            showMessage(`–ü–æ–≤—Ç–æ—Ä–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ ${brokenLinks.length} —Å—á—É–ø–µ–Ω–∏ –ª–∏–Ω–∫–∞...`, 'info');

            // Reset broken links to pending
            brokenLinks.forEach(link => {
                link.status = 'pending';
                link.statusCode = null,
                link.responseTime = null,
                link.error = null
            });

            updateStats();
            renderResults();

            // Check only the broken links
            await checkLinksBatch(brokenLinks);

            const stillBroken = brokenLinks.filter(l => l.status === 'error').length;
            const fixed = brokenLinks.length - stillBroken;

            if (fixed > 0) {
                showMessage(`–ü–æ–ø—Ä–∞–≤–µ–Ω–∏ ${fixed} –ª–∏–Ω–∫–∞, ${stillBroken} –≤—Å–µ –æ—â–µ —Å—á—É–ø–µ–Ω–∏`, 'success');
            } else {
                showMessage('–ù–∏—Ç–æ –µ–¥–∏–Ω –ª–∏–Ω–∫ –Ω–µ –±–µ—à–µ –ø–æ–ø—Ä–∞–≤–µ–Ω', 'warning');
            }
        }

        function copyBrokenLinks() {
            const brokenLinks = allLinks.filter(l => l.status === 'error');
            if (brokenLinks.length === 0) {
                showMessage('–ù—è–º–∞ —Å—á—É–ø–µ–Ω–∏ –ª–∏–Ω–∫–æ–≤–µ –∑–∞ –∫–æ–ø–∏—Ä–∞–Ω–µ', 'warning');
                return;
            }

            const brokenUrls = brokenLinks.map(link => link.url).join('\n');

            navigator.clipboard.writeText(brokenUrls).then(() => {
                showMessage(`–ö–æ–ø–∏—Ä–∞–Ω–∏ —Å–∞ ${brokenLinks.length} —Å—á—É–ø–µ–Ω–∏ –ª–∏–Ω–∫–∞ –≤ –∫–ª–∏–ø–±–æ—Ä–¥–∞`, 'success');
            }).catch(() => {
                showMessage('–ù–µ—É—Å–ø–µ—à–Ω–æ –∫–æ–ø–∏—Ä–∞–Ω–µ –≤ –∫–ª–∏–ø–±–æ—Ä–¥–∞', 'error');
            });
        }

        function clearResults() {
            if (isChecking) return;

            allLinks = [];
            currentFilter = 'all';

            elements.statsSection.classList.add('hidden');
            elements.progressSection.classList.add('hidden');
            elements.resultsSection.classList.add('hidden');
            elements.refreshBrokenBtn.classList.add('hidden');
            elements.copyBrokenBtn.classList.add('hidden');

            elements.progressFill.style.width = '0%';
            elements.progressText.textContent = '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...';

            updateStats();
            renderResults();

            showMessage('–†–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ —Å–∞ –∏–∑—á–∏—Å—Ç–µ–Ω–∏', 'info');
        }

        // Initialize the application
        init();
    </script>
</body>
</html>
